openapi: 3.0.3
info:
  title: Authentication API
  description: User authentication endpoints for signup, signin, and token management
  version: 1.0.0
  contact:
    name: Physical AI Textbook Team
    email: support@example.com

servers:
  - url: http://localhost:8000/api
    description: Development server
  - url: https://api.production.example.com/api
    description: Production server

tags:
  - name: Authentication
    description: User authentication operations

paths:
  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: |
        Create a new user account with email/password and collect user profile
        (skill levels and hardware access).

        **Validation Rules**:
        - Email: Valid format, must be unique
        - Password: Min 8 chars, 1 uppercase, 1 lowercase, 1 number
        - Skill levels: All 5 required, values 1-5
        - Hardware access: Optional (can be all false)
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              beginner-cloud-only:
                summary: Beginner user with no hardware
                value:
                  email: "beginner@example.com"
                  password: "SecurePass123"
                  skillLevels:
                    ai: 1
                    ml: 1
                    ros: 1
                    python: 2
                    linux: 2
                  hardwareAccess:
                    gpu: false
                    jetson: false
                    robot: false
              advanced-with-gpu:
                summary: Advanced user with GPU access
                value:
                  email: "advanced@example.com"
                  password: "SecurePass123"
                  skillLevels:
                    ai: 4
                    ml: 4
                    ros: 3
                    python: 4
                    linux: 4
                  hardwareAccess:
                    gpu: true
                    jetson: false
                    robot: false
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignupResponse'
        '400':
          description: Validation error (invalid input)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid-email:
                  value:
                    error: "Invalid email format"
                    details:
                      field: "email"
                      message: "Must be a valid email address"
                weak-password:
                  value:
                    error: "Password does not meet complexity requirements"
                    details:
                      field: "password"
                      message: "Must contain at least one uppercase, one lowercase, and one digit"
        '409':
          description: Conflict (email already registered)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Email already registered"
                details:
                  field: "email"
                  message: "An account with this email already exists"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/signin:
    post:
      tags:
        - Authentication
      summary: Sign in existing user
      description: Authenticate user with email/password and return JWT tokens
      operationId: signin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SigninRequest'
      responses:
        '200':
          description: Sign in successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SigninResponse'
        '401':
          description: Unauthorized (invalid credentials)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid credentials"
                details:
                  message: "Email or password is incorrect"
        '429':
          description: Too many requests (rate limit exceeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Generate new access token using refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: Unauthorized (invalid or expired refresh token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Log out user
      description: Invalidate refresh token (client should also delete stored tokens)
      operationId: logout
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Logged out successfully"
        '401':
          description: Unauthorized (invalid token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/signin or /auth/refresh

  schemas:
    SignupRequest:
      type: object
      required:
        - email
        - password
        - skillLevels
        - hardwareAccess
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
          description: User's email address (login identifier)
        password:
          type: string
          format: password
          minLength: 8
          example: "SecurePass123"
          description: Password (min 8 chars, 1 uppercase, 1 lowercase, 1 number)
        skillLevels:
          type: object
          required:
            - ai
            - ml
            - ros
            - python
            - linux
          properties:
            ai:
              type: integer
              minimum: 1
              maximum: 5
              example: 3
              description: AI skill level (1=Beginner, 5=Expert)
            ml:
              type: integer
              minimum: 1
              maximum: 5
              example: 3
            ros:
              type: integer
              minimum: 1
              maximum: 5
              example: 2
            python:
              type: integer
              minimum: 1
              maximum: 5
              example: 4
            linux:
              type: integer
              minimum: 1
              maximum: 5
              example: 3
        hardwareAccess:
          type: object
          required:
            - gpu
            - jetson
            - robot
          properties:
            gpu:
              type: boolean
              example: false
              description: User has access to GPU hardware
            jetson:
              type: boolean
              example: false
              description: User has access to NVIDIA Jetson device
            robot:
              type: boolean
              example: false
              description: User has access to physical robot

    SignupResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440000"
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                createdAt:
                  type: string
                  format: date-time
                  example: "2025-12-17T10:30:00Z"
            tokens:
              $ref: '#/components/schemas/AuthTokens'
            profile:
              $ref: '#/components/schemas/UserProfile'

    SigninRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
        password:
          type: string
          format: password
          example: "SecurePass123"

    SigninResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                email:
                  type: string
                  format: email
            tokens:
              $ref: '#/components/schemas/AuthTokens'
            profile:
              $ref: '#/components/schemas/UserProfile'

    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          description: Refresh token obtained from signup/signin

    RefreshTokenResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            accessToken:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            refreshToken:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              description: New refresh token (rotation)

    LogoutRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          description: Refresh token to invalidate

    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          description: JWT access token (15-minute expiry)
        refreshToken:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          description: JWT refresh token (7-day expiry)

    UserProfile:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        skillLevels:
          type: object
          properties:
            ai:
              type: integer
              minimum: 1
              maximum: 5
            ml:
              type: integer
              minimum: 1
              maximum: 5
            ros:
              type: integer
              minimum: 1
              maximum: 5
            python:
              type: integer
              minimum: 1
              maximum: 5
            linux:
              type: integer
              minimum: 1
              maximum: 5
        hardwareAccess:
          type: object
          properties:
            gpu:
              type: boolean
            jetson:
              type: boolean
            robot:
              type: boolean
            cloudOnly:
              type: boolean
              description: Computed field (true if no hardware selected)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Validation error"
        details:
          type: object
          additionalProperties: true
          example:
            field: "email"
            message: "Invalid email format"
